const { addonBuilder, serveHTTP } = require('stremio-addon-sdk');
const fetch = require('node-fetch');
const fs = require('fs');
const config = require('./config.json');

const manifest = {
  id: 'org.lumestream.addon',
  version: '1.0.0',
  name: 'LumeStream Mejorado',
  description: 'Addon con enlaces funcionales y traducción al castellano',
  resources: ["catalog", "stream"],
  types: ["movie", "series", "channel"],
  catalogs: config.categories.map(category => ({
    type: category.toLowerCase(),
    id: category.toLowerCase(),
    name: category,
    extra: []
  })),
  idPrefixes: ["lumestream"]
};

const builder = new addonBuilder(manifest);

// Función para obtener streams de tus fuentes
async function getStreams(type, id) {
  let streams = [];
  
  // Peerflix
  if (config.sources.includes("peerflix")) {
    // Ejemplo de stream (sustituir con API real)
    streams.push({
      title: "Ejemplo Peerflix",
      url: "magnet:?xt=urn:btih:EXAMPLEHASH",
      type: "magnet"
    });
  }
  
  // Torrentio
  if (config.sources.includes("torrentio")) {
    streams.push({
      title: "Ejemplo Torrentio",
      url: "magnet:?xt=urn:btih:EXAMPLETORRENT",
      type: "magnet"
    });
  }

  return streams;
}

// Manejo de streams
builder.defineStreamHandler(async ({ type, id }) => {
  const streams = await getStreams(type, id);
  return { streams };
});

// Catálogo simplificado con traducción
builder.defineCatalogHandler(async ({ type, id }) => {
  // Ejemplo simple de catálogo
  return {
    metas: [
      {
        id: `${type}-001`,
        type,
        name: type === "movie" ? "Película de ejemplo" : "Serie de ejemplo",
        poster: "https://via.placeholder.com/300x450?text=Ejemplo",
        description: `Descripción en castellano para ${type}`,
        released: 2026
      }
    ]
  };
});

// Servir en puerto de Render
const port = process.env.PORT || 3000;
serveHTTP(builder, { port });
console.log(`Addon LumeStream corriendo en puerto ${port}`);
